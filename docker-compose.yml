version: '3.8'
services:
  webapp_stores:
      build:
        context: ./
        target: app
      container_name: stores
      restart: unless-stopped
      volumes:
        - ./:/app
#      ports:
#        - "5000:5000"
      expose:
        - 5000
      command: gunicorn --bind 0.0.0.0:5000 manage:app #python manage.py run -h 0.0.0.0
      env_file:
        - ./.env
      networks:
        - my-network

#      depends_on:
#        - redis
#        - celery
#        - flower
  nginx:
    build:
      context: ./
      target: nginx
    ports:
      - 1337:80
    networks:
      - my-network
    links:
      - webapp_stores
    depends_on:
      - webapp_stores
#  celery:
#    build: ./
#    container_name: celery
##    networks: my_network
#    restart: unless-stopped
#    environment:
#      - CELERY_BROKER_URL=redis://redis:6379/
#      - FLASK_APP=webapp_stores
#    command: celery -A tasks worker --loglevel=INFO && celery -A tasks beat
#
#  flower:
#    image: mher/flower:latest
##    networks: my_network
#    command: flower
#    ports:
#      - "5555:5555"
#    depends_on:
#      - celery
#  redis:
#    image: "redis:alpine"
##    ports:
##      - "6379:6379"
##    networks: my_network
networks:
    my-network: